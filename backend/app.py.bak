# backend/app.py
import uvicorn
from fastapi import FastAPI, UploadFile, File, Depends, HTTPException
from fastapi.middleware.cors import CORSMiddleware
from typing import Dict, Any
import json
from config import settings
from schemas import Token, LoginRequest, IngestResult
from auth import create_access_token, get_current_user
from ingest_stix import ingest_stix_json
from ingest_misp import ingest_misp_json
from db import merge_node, search_nodes_by_name, get_subgraph
from ml_utils import compute_anomaly_scores_graph, cluster_nodes_sample

app = FastAPI(title=settings.APP_NAME)

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

@app.get("/health")
def health():
    return {"status": "ok", "app": settings.APP_NAME}

@app.post("/auth/login", response_model=Token)
def login(payload: LoginRequest):
    # very simple username/password check
    if payload.username == settings.DEFAULT_ADMIN_USER and payload.password == settings.DEFAULT_ADMIN_PASS:
        token = create_access_token({"sub": payload.username})
        return {"access_token": token, "token_type": "bearer"}
    raise HTTPException(status_code=401, detail="Invalid credentials")

@app.post("/ingest/stix", response_model=IngestResult)
async def ingest_stix(file: UploadFile = File(...), current_user: Dict = Depends(get_current_user)):
    if not file:
        raise HTTPException(status_code=400, detail="Missing file")
    content = await file.read()
    try:
        data = json.loads(content)
    except Exception:
        raise HTTPException(status_code=400, detail="Invalid JSON")
    nodes, rels = ingest_stix_json(data)
    return {"ingested_nodes": nodes, "ingested_rels": rels}

@app.post("/ingest/misp", response_model=IngestResult)
async def ingest_misp(file: UploadFile = File(...), current_user: Dict = Depends(get_current_user)):
    if not file:
        raise HTTPException(status_code=400, detail="Missing file")
    content = await file.read()
    try:
        data = json.loads(content)
    except Exception:
        raise HTTPException(status_code=400, detail="Invalid JSON")
    nodes, rels = ingest_misp_json(data)
    return {"ingested_nodes": nodes, "ingested_rels": rels}

@app.get("/search")
def search(q: str, current_user: Dict = Depends(get_current_user)):
    results = search_nodes_by_name(q)
    return results

@app.get("/graph/{uid}")
def subgraph(uid: str, depth: int = 1, current_user: Dict = Depends(get_current_user)):
    return get_subgraph(uid, depth)

@app.get("/ml/anomaly/{uid}")
def ml_anomaly(uid: str, depth: int = 2, current_user: Dict = Depends(get_current_user)):
    return compute_anomaly_scores_graph(uid, depth)

@app.get("/ml/cluster/{uid}")
def ml_cluster(uid: str, depth: int = 2, current_user: Dict = Depends(get_current_user)):
    return cluster_nodes_sample(uid, depth)

if __name__ == "__main__":
    uvicorn.run("app:app", host="0.0.0.0", port=8000, reload=True)
# ---- Added helper endpoint to load sample files directly (one-time convenience) ----
# Usage: POST /ingest/load-samples
# This endpoint reads backend/sample_data/sample_stix.json and sample_misp.json (if present)
# and calls the existing ingest functions to load them into the graph. It is intentionally
# unauthenticated for local-prototyping convenience. Remove or secure in production.
from fastapi import Response
import os, json

@app.post("/ingest/load-samples")
def ingest_load_samples():
    base = os.path.join(os.path.dirname(__file__), "sample_data")
    results = {"files_processed": [], "total_nodes": 0, "total_rels": 0}
    # STIX
    stix_path = os.path.join(base, "sample_stix.json")
    if os.path.exists(stix_path):
        try:
            with open(stix_path, "r", encoding="utf-8") as f:
                stix_json = json.load(f)
            n, r = ingest_stix_json(stix_json)
            results["files_processed"].append("sample_stix.json")
            results["total_nodes"] += int(n)
            results["total_rels"] += int(r)
        except Exception as e:
            return Response(content=f"Error ingesting STIX: {e}", status_code=500)
    # MISP
    misp_path = os.path.join(base, "sample_misp.json")
    if os.path.exists(misp_path):
        try:
            with open(misp_path, "r", encoding="utf-8") as f:
                misp_json = json.load(f)
            n, r = ingest_misp_json(misp_json)
            results["files_processed"].append("sample_misp.json")
            results["total_nodes"] += int(n)
            results["total_rels"] += int(r)
        except Exception as e:
            return Response(content=f"Error ingesting MISP: {e}", status_code=500)
    if not results["files_processed"]:
        return {"message": "No sample files found in backend/sample_data - nothing to ingest."}
    return results
# ---- end of helper endpoint ----
